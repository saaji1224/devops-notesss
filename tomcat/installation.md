## creation of vm 
```bash
gcloud compute instances create tomcat --zone=us-west4-b
--machine-type=e2-medium --create-disk=auto-delete=yes,boot=yes,device-name=tomcat,image=projects/centos-cloud/global/images/centos-7-v20240515,mode=rw,size=20
```

## Installting java 1.8 on CentOs 
```bash
 cd /opt

 yum install wget -y

 wget -c --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.rpm

 yum install jdk-8u131-linux-x64.rpm -y

 java -version
```
## Tomact 9 installation 
link [download](https://tomcat.apache.org/download-90.cgi)
```bash
wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.89/bin/apache-tomcat-9.0.89.zip

yum install unzip -y

unzip apache-tomcat-9.0.89.zip

mv apache-tomcat-9.0.89 tomcat9

 * need to check tomcat is runnig are not [ip_address:8080]
ps -ef | grep -i java*  ## this command will helping us to get the process that is been runnig inside the linux server

#start the tomcat process
cd /opt/tomcat9/bin
sh startup.sh   ##This will not run as the files i  bin folder are not having executable permission 
chmod +x *   #it will give execute permission to all files
sh startup.sh 

# we should run the above command by switching to a particular directory 
# We cant run the command from any where else.

# to start and stop the tomcat from anywhere in the vm, we can create link

ln -s /opt/tomcat9/bin/startup.sh /usr/bin/startTomcat
ln -s /opt/tomcat9/bin/shutdown.sh /usr/bin/stopTomcat
```
## Access Tomcat server from web
  * Once the tomcat is successfuly started, we can acces tomcat server at public_ip:8080 
  * Once the homepage click on `manger app` and `hostmanger` the page will populate with `403`
  * We need to perform the following steps to come out of this issue 
## Manger app
```bash
# It gives 403 Access Denied 
cd /opt/tomcat9/webapps/manager/META-INF
vi context.xml
# commanet the below line
<!--
<Valve className="org.apache.catalina.valves.RemoteAddrValve"
         allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1" />
-->

```
  * manager-gui --> manager/service status/application deployment 
  * admin-gui  ---> host manager
* After we save the file now try to access the manager page from the web. we should be able to get login   page

* Try to access hostmanger from the we, still u will be getting `403`,
because we have made a mofification in the `context.xml` file under `manager` only 
* If you want to reflect the same to `hostmanager` perform the above setup here as well.

## Credentials for login to manger 
* We need to perform the following steps to create a `user` and access tomcat from the user.

```bash

cd /opt/tomcat9/conf

vi tomcat-users.xml  # add this lines in above file 
 <user username="saacademy" password="password" roles="manager-gui,admin-gui,manager,admin-script,manager-script,manager-status,manager-jmx" />
```
* After this modification try to login to `manager` with the above credentials
    * application ---> war -----> deploy to `tomcat`

* if we want to change the port number 
```bash (optional)
cd /opt/tomcat9/conf
vi server.xml 
Connector port="8082" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443"
               maxParameterCount="1000"
               />
cd /opt/tomcat9/bin
sh shutdown.sh
sh startup.sh
(or)
public_ip:8082

stopTomcat
startTomcat

```
## Deploy flow
 `SRC` ---> `mvn package`(jar/war) ---> `deploy`

 ## Tomcat directory startucre
  * `bin`
      * This directory will be having all binary file related to start and stop tomcat server.
      * It will be consisting of startup and shutdown scripts
          `startup.sh`
             * This file is used to start the tomcat server on linux/mac machines
          `startup.bat`
             *  This file is used to start the tomcat server windows machines
          `catalina.sh`
             * this file is used to stop and start the tomact server like `restart`
  * `conf`
      * This contains the configuration file for tomcat
      * In maven we are having some thing called as `setting.xml`
      * In tomcat we have most importent file called as `server.xml` and `tomcat-user.xml` 
  * `lib`
      * This will be consist of libraries
      * Any software that is been developed by java will be consisting of jar files.
      * This jar files are used to run tomcat server. 
  * `logs`
      * This logs are for tomcat server not your typical applocation
      * By default when we download/unarchive the tomcat server this log folder will be empty
      * Once we start the tomcat server it generate typically 4 files
         * manger.log
         * hostmanger.log
         * catalina.out
         * localhost.log
  * `webapps`
      * We will be generally deploying our application based artifact which is been generated by maven in this folder
      * By default there will be 5 apps in the  `webapps` directory
      * We can deploy our custom application here and it support n number of application 
  * `temp`
      * It consists of all the `temp` files
  * `work`
      * Once we deploy the application in the webapps folder those apps generating some files(eg:jar, pom.xml,property) these are store in work directory

      ## install web servers in Centos, redhat
      ```bash
      yum install httpd

      apt install apache2 #for ubuntu
      
      ```

      ## commands
    ```bash

    setsebool -P httpd_can_network_connect 1
    setsebool -P httpd_can_network_connect 1
    setsebool -P httpd_can_network_relay 1
    setsebool -P httpd_graceful_shutdown 1
    setsebool -P nis_enabled 1
    systemctl restart httpd
    ```

    ### SonarQube
     * It is a code quality tool
     * It is a web based tool
     * It will support to both open source as well as paid 
     * It supports multiple `Data bases` 
         * `MySql`
         * `Oracle`
     * SonarQube will not validate the logic of test cases
     * It is self managed static code tool for continous code based inspection

     ## Sonar Qube installatio
     # create vm 
     ```bash
     gcloud compute instances create sonarqube  --zone=us-west4-b --machine-type=e2-medium  --create-disk=auto-delete=yes,boot=yes,device-name=sonarqube,image=projects/centos-cloud/global/images/centos-7-v20230615,mode=rw,size=20
     ```
 ## Install Openjdk 17, mvn 3.8.8 on Centos:
```bash
# https://techviewleo.com/install-java-openjdk-on-rocky-linux-centos/
# Install Openjdk 17
sudo yum -y install wget curl
cd /opt/
wget https://download.java.net/java/GA/jdk17.0.2/dfd4a8d0985749f896bed50d7138ee7f/8/GPL/openjdk-17.0.2_linux-x64_bin.tar.gz
tar xvf openjdk-17.0.2_linux-x64_bin.tar.gz
sudo mv jdk-17.0.2/ /opt/jdk-17/
vim ~/.bashrc
  export JAVA_HOME=/opt/jdk-17
  export PATH=$PATH:$JAVA_HOME/bin
source ~/.bashrc
echo $JAVA_HOME
java --version

# Install Maven 3.8.8
cd /opt/
# wget https://dlcdn.apache.org/maven/maven-3/3.8.7/binaries/apache-maven-3.8.7-bin.tar.gz
wget https://dlcdn.apache.org/maven/maven-3/3.8.8/binaries/apache-maven-3.8.8-bin.tar.gz
tar -xzvf apache-maven-3.8.8-bin.tar.gz
vi ~/.bashrc
  export PATH=$PATH:/opt/apache-maven-3.8.8/bin
  export M2_HOME=/opt/apache-maven-3.8.8
source ~/.bashrc
mvn --version
# mvn package -DskipTests
# For All Users
---------------------- 
vi /etc/profile
  export JAVA_HOME=/opt/jdk-17
  export PATH=$PATH:$JAVA_HOME/bin
  export PATH=$PATH:/opt/apache-maven-3.8.8/bin
  export M2_HOME=/opt/apache-maven-3.8.8

source /etc/profile
mvn --version     
```
### Sonarqube instaling
```bash 
yum install unzip -y
wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-9.9.5.90363.zip
unzip sonarqube-9.9.5.90363.zip
mv sonarqube-9.9.5.90363 sonarqube-9.9
```
* by default Sonar will not be executed with `root` user
* We need to create a `user` called as sonar and start the applicaiton with that user

 ```bash
 useradd sonar

 visudo
sonar           ALL=(ALL)       NOPASSWD: ALL
chown -R sonar:sonar /opt/sonarqube-9.9
#chmod -R 775 /opt/sonarqube-9.9
```
- Once this is done we need run/start the sonar
- sonarqube will be started by `sonar` user
- we need to switch to sonar user

```bash
# switch sonar user

su - sonar
cd /opt/sonarqube-9.9
cd bin
cd linux-x86-64/
sh sonar.sh start

# To Verify status of sonarqube
sh sonar.sh status
```
- Once the installation is successful, sonarqube can be acessible at port `9000`
- It will ask for userid/passwd.
    * By default sonarqube has created as userid as `admin` and password as `admin`
    * Popup appears to change the password. Do change it and makesure u remember the password, as its difficult to get it back.

## Create a sample maven project
```bash
# https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html
mvn archetype:generate -DgroupId=com.sivaacademy.app -DartifactId=my-maven-app -DarchetypeArtifactId=maven-archetype-quickstart -DarchetypeVersion=1.4 -DinteractiveMode=false
# mvn compile > mvn package
vi pom.xml
<properties>
  <sonar.host.url>http://34.125.87.116:9000/</sonar.host.url>
  <sonar.login>admin</sonar.login>
  <sonar.password>sonar1234</sonar.password>
</properties>

(or)
vi pom.xml
<properties>
  <sonar.host.url>http://34.125.87.116:9000/</sonar.host.url>
  <sonar.login>sqa_4d1dced90813806e1bf26b6ea4e3fba080e84507</sonar.login>
</properties>
--> In real time we will never use user name and password 
--> we will be using something called as a "toke"
mvn sonar:sonar
```
## Instead of passwords we can use tokens well
  * Create token
  ```bash
   Sonar > MyAccount > Security > Generate Tokens[name: ; type:Global analysis token;exp: 30 days] > generate toke [sqa_4d1dced90813806e1bf26b6ea4e3fba080e84507]
    or
   Administration > Security > users 
  ``` 
--> When i say instead of using user and password i am using something called as `token` at the same time im also saying  that token is nothing but combination of user id and password 

```bash
mvn compile sonar:sonar -Dsonar.host.url=http://34.125.169.221:9000/ -Dsonar.login=sqa_4d1dced90813806e1bf26b6ea4e3fba080e84507

--> in jenkins we can use credentials it is recommended 
```
# this command shows the available java versions
```bash
alternatives --config java
```
## sonar scan for Gradle project
```bash
# clone the git repo
git clone https://github.com/GoogleCloudPlatform/cloud-ops-sandbox.git
# switch to 
csb_1220
git checkout csb_1220
cd cloud-ops-sandbox
cd src/adservice

# to build and test the app with gradle
./gradle installDist

# if you want to perform sonar scan for this Project
# Create a project in sonarqube >> get the command from there along with the existing token
# modify the build gradle file with the sonar plugin
vi build.gradle
plugins {
    id "org.sonarqube" version "3.5.0.2730"  ## add this line in sonarqube > create project > manual > project key > use exit token > gradle
    id 'com.google.protobuf' version '0.8.16'}
# to run the below command to perform sonarscan for gradle
./gradlew sonar   -Dsonar.projectKey=addservice   -Dsonar.host.url=http://34.16.187.109:9000 -Dsonarlogin=sqa_4d1dced90813806e1bf26b6ea4e3fba080e84507 
# if we get any error with respect to java version install jdk 11 on the machine
yum search jdk
yum install java-11-openjdk.i686 -y
# copy the relevant java path from the below location
alternatives --config java

# now we got the java 11 path pass on the java to gradle command
./gradlew sonar   -Dsonar.projectKey=addservice   -Dsonar.host.url=http://public_url_sonar:9000 -Dsonarlogin=your_sonar_token -Dorg.gradle.java.home=/usr/lib/jvm/java-11-openjdk-11.0.23.0.9-2.el7_9.i386

# once the scan is perform go to sonar and verify your result
```
# details of some options in sonarqube
  * `Rules` : This are the things that are been based while your performing certain test and all 
  * `Quality Profiles`: Collection of `Rules`
  * `Quality Gates`
## categary
* Critical  ---> for production `0`
* High
* Medium
* Low
## Create Quality Profile
  * go to sonar qube > Quality Profile > create >Create a blank quality profile > Language: java > Name: >create


# Nexus
* Nexus is a Artifact Repository
* It can store both application artifacts as well as Container images as well
* Its parent company is Sonatype Nexus
* Nexus is been an alternative for JFROG
* Nexus is a Opensource java based artifact based repo/manager
* There are two types of nexus,which can be configured
  * Nexus OSS (Open Source Software)
  * Nexus Pro (Enterprise Edition)
# Install Nexus on CentOs
```bash 
# Create a one server
gcloud compute instances create nexusserver --zone=us-west4-b --machine-type=e2-medium --create-disk=auto-delete=yes,boot=yes,device-name=sonar,image=projects/centos-cloud/global/images/centos-7-v20221206,mode=rw,size=20

# Install Java 1.8
cd /opt
yum install wget -y
wget -c --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.rpm

yum install jdk-8u131-linux-x64.rpm -y

# Download Nexus 
# TO get latest version use the below url
# https://help.sonatype.com/repomanager3/product-information/download/download-archives---repository-manager-3
wget https://download.sonatype.com/nexus/3/nexus-3.45.0-01-unix.tar.gz
tar -xzvf nexus-3.45.0-01-unix.tar.gz
mv nexus-3.45.0-01 /opt/nexus

# Create a nexus user.
# Nexus is not advised to run nexus service as a root user.
# So, we are creating a  user called nexus and grant sudo access to manage nexus services.
useradd nexus

#Give the sudo access to nexus user

visudo
nexus ALL=(ALL) NOPASSWD: ALL

#Change the owner and group permissions to /opt/nexus directory
chown -R nexus:nexus /opt/nexus
chmod -R 775 /opt/nexus
#Change the owner and group permissions to /opt/sonatype-work directory.
chown -R nexus:nexus /opt/sonatype-work
chmod -R 775 /opt/sonatype-work

#Open /opt/nexus/bin/nexus.rc file and  uncomment run_as_user parameter and set as nexus user.
vi /opt/nexus/bin/nexus.rc
run_as_user="nexus"

#Create nexus as a service
ln -s /opt/nexus/bin/nexus /etc/init.d/nexus

#Switch as a nexus user and start the nexus service as follows.
sudo su - nexus

#Enable the nexus services
sudo systemctl enable nexus

#Start the nexus service
sudo systemctl start nexus
```
# # Install Nexus on Ubuntu
```bash
# Install Java 
apt install openjdk-8-jdk -y

# COnfigure Maven 

wget https://download.java.net/java/GA/jdk17.0.2/dfd4a8d0985749f896bed50d7138ee7f/8/GPL/openjdk-17.0.2_linux-x64_bin.tar.gz
tar xvf openjdk-17.0.2_linux-x64_bin.tar.gz
sudo mv jdk-17.0.2/ /opt/jdk-17/

# Install maven
wget https://dlcdn.apache.org/maven/maven-3/3.8.8/binaries/apache-maven-3.8.8-bin.tar.gz
tar -xvf apache-maven-3.8.8-bin.tar.gz

vi /etc/profile
export JAVA_HOME=/opt/jdk-17
export PATH=$PATH:$JAVA_HOME/bin
export PATH=$PATH:/opt/apache-maven-3.8.8/bin
export M2_HOME=/opt/apache-maven-3.8.8

source /etc/profile

# Install/Configure Nexus 

# Download Nexus 
# TO get latest version use the below url
# https://help.sonatype.com/repomanager3/product-information/download/download-archives---repository-manager-3
wget https://download.sonatype.com/nexus/3/nexus-3.68.0-04-java8-unix.tar.gz
tar -xvf nexus-3.68.0-04-java8-unix.tar.gz 
mv nexus-3.45.0-01 /opt/nexus

# Create a nexus user.
# Nexus is not advised to run nexus service as a root user.
# So, we are creating a  user called nexus and grant sudo access to manage nexus services.
#useradd nexus
adduser nexus
#Give the sudo access to nexus user

visudo
nexus ALL=(ALL) NOPASSWD: ALL

#Change the owner and group permissions to /opt/nexus directory
chown -R nexus:nexus /opt/nexus
chmod -R 775 /opt/nexus
#Change the owner and group permissions to /opt/sonatype-work directory.
chown -R nexus:nexus /opt/sonatype-work
chmod -R 775 /opt/sonatype-work

#Open /opt/nexus/bin/nexus.rc file and  uncomment run_as_user parameter and set as nexus user.
vi /opt/nexus/bin/nexus.rc
run_as_user="nexus"

#Create nexus as a service
ln -s /opt/nexus/bin/nexus /etc/init.d/nexus

#Switch as a nexus user and start the nexus service as follows.
sudo su - nexus

#Enable the nexus services
sudo systemctl enable nexus

#Start the nexus service
sudo systemctl start nexus


# Access Nexus Repo
ip_address:8081
```
# Login to Nexus
```bash
# Admin user password is located in 
/opt/sonatype-work/nexus3/admin.password
```
# Change Port
```bash
# vim  /opt/nexus/etc/nexus-default.properties
change the port
service nexus restart
```
# spring pet clinic
* Create four servers
  * Build
  * Sonar
    * pom.xml 
      * edit pom.xml and configure token
```bash
  <sonar.host.url>http://34.42.38.27:9000/</sonar.host.url>
  <sonar.login>sqa_2ae56d82cfdbb7d51e4048d5a4aeb233457e4ce0</sonar.login>
```
    * mvn sonar:sonar -D
    * sonar.properties
  * Nexus
    * maven configuration in `conf/setting.xml` and servers
    * Add the tag in `pom.xml` under `distrubtion management`
```bash
* Login to nexus 
  * settings > repositories > create repository: maven2hosted > name: first-release > version policy: Release >deployment policy: allow redeploy 
  * and copy the repo url:http://34.41.70.162:8081/repository/first-release/ and configure this url in pom.xml
  * and create another repository >settings > repositories > create repository: maven2hosted > name: first-release > version policy: sanshot >deployment policy: allow redeploy
  * copy the url of repo http://34.41.70.162:8081/repository/first-snapshot/
pom.xml
  <distributionManagement>
      <repository>
          <id>nexus</id>  
          <name>Release Repos</name>
          <url>http://34.41.70.162:8081/repository/first-release/</url>
       </repository>
      <snapshotRepository>
          <id>nexus</id>
          <name>Snapshot Repos</name>
          <url>http://34.41.70.162:8081/repository/first-snapshot/</url>
      </snapshotRepository>
  </distributionManagement>
```
  * Tomcat
```bash
* Create a one free style job
  * Configure SCM 
  * Go to sonar > security > token name: jenkins_token; type: Global;Expiresin : 30 > sqa_2ae56d82cfdbb7d51e4048d5a4aeb233457e4ce0
  * Copy that token and configure that token in pom.xml file i edit above like that.
  * configure > build steps maven version:mymaven; Golas: clean package sonar:sonar > build successfull 
    * And check the sonarqube the project is deployed 
  * Upload the jar file into the nexus
    *    configure > build steps maven version:mymaven; Golas: clean deploy sonar:sonar > build faild beacuse we are not configure `settings.xml` file thats why build is faild
  * 
[error]
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-deploy-plugin:2.8.2:deploy (default-deploy) on project my-maven-app: Failed to retrieve remote metadata com.sivaacademy.app:my-maven-app:1.0-SNAPSHOT/maven-metadata.xml: Could not transfer metadata com.sivaacademy.app:my-maven-app:1.0-SNAPSHOT/maven-metadata.xml from/to nexus (http://34.41.70.162:8081/repository/first-snapshot/): authentication failed for http://34.41.70.162:8081/repository/first-snapshot/com/sivaacademy/app/my-maven-app/1.0-SNAPSHOT/maven-metadata.xml, status: 401 Unauthorized -> [Help 1]
[ERROR] 
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR] 
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoExecutionException 

# vi vi /opt/apache-maven-3.8.8/conf/settings.xml 
</server>
    -->
    <server>
      <id>nexus</id>
      <username>admin</username>
      <password>admin@123</password>
    </server>
  </servers>
  * Re run the job and build successfull
```
